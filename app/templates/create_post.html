{% extends "base.html" %}
{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-dark text-white">
        <h3 class="mb-0"><i class="fas fa-plus-circle"></i> {{ legend }}</h3>
    </div>
    <div class="card-body">
        <form method="POST" action="" enctype="multipart/form-data">
            {{ form.hidden_tag() }}

            <!-- Post Type Selection -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.post_type.label(class="form-control-label font-weight-bold") }}
                        {{ form.post_type(class="form-control form-control-lg") }}
                        <small class="form-text text-muted">Select the type of action plan.</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.project_area.label(class="form-control-label font-weight-bold") }}
                        {{ form.project_area(class="form-control form-control-lg", placeholder="e.g., Assembly / Main
                        Line") }}
                        <small class="form-text text-muted">Project and area (optional).</small>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <!-- Problem & Corrective Action Section -->
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        {{ form.problem.label(class="form-control-label font-weight-bold") }}
                        {{ form.problem(class="form-control form-control-lg" + (" is-invalid" if form.problem.errors
                        else ""), placeholder="Describe the problem or opportunity") }}
                        {% if form.problem.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.problem.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="form-control-label font-weight-bold"><i class="fas fa-camera text-warning"></i>
                            Problem/Opportunity Image</label>
                        <div class="drop-zone" id="drop-zone-problem">
                            <span class="drop-zone__prompt">Click to focus, then Drop or Paste image here</span>
                            <button type="button" class="btn btn-sm btn-secondary mt-2 drop-zone__btn">Choose
                                Image</button>
                            {{ form.image_problem(class="drop-zone__input") }}
                        </div>
                        {% if form.image_problem.errors %}
                        {% for error in form.image_problem.errors %}
                        <div class="text-danger mt-2">{{ error }}</div>
                        {% endfor %}
                        {% endif %}
                        <small class="form-text text-muted">Upload image showing the problem.</small>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="form-group">
                        {{ form.corrective_action.label(class="form-control-label font-weight-bold") }}
                        {{ form.corrective_action(class="form-control form-control-lg" + (" is-invalid" if
                        form.corrective_action.errors else ""), placeholder="Action to resolve the issue") }}
                        {% if form.corrective_action.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.corrective_action.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        {{ form.responsible.label(class="form-control-label font-weight-bold") }}
                        {{ form.responsible(class="form-control form-control-lg" + (" is-invalid" if
                        form.responsible.errors else ""), placeholder="Person responsible") }}
                        {% if form.responsible.errors %}
                        <div class="invalid-feedback">
                            {% for error in form.responsible.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="form-group">
                        <label class="form-control-label font-weight-bold"><i class="fas fa-camera text-success"></i>
                            Corrective Action Image</label>
                        <div class="drop-zone" id="drop-zone-corrective">
                            <span class="drop-zone__prompt">Click to focus, then Drop or Paste image here</span>
                            <button type="button" class="btn btn-sm btn-secondary mt-2 drop-zone__btn">Choose
                                Image</button>
                            {{ form.image_corrective(class="drop-zone__input") }}
                        </div>
                        {% if form.image_corrective.errors %}
                        {% for error in form.image_corrective.errors %}
                        <div class="text-danger mt-2">{{ error }}</div>
                        {% endfor %}
                        {% endif %}
                        <small class="form-text text-muted">Upload image to complete the action.</small>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <!-- Dates Section -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.audit_date.label(class="form-control-label font-weight-bold") }}
                        {{ form.audit_date(class="form-control form-control-lg", type="date") }}
                        <small class="form-text text-muted">When the audit occurred.</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.audit_type.label(class="form-control-label font-weight-bold") }}
                        {{ form.audit_type(class="form-control form-control-lg") }}
                        <small class="form-text text-muted">Type of audit performed.</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.date_realization.label(class="form-control-label font-weight-bold") }}
                        {{ form.date_realization(class="form-control form-control-lg", type="date") }}
                        {% if form.date_realization.errors %}
                        <div class="text-danger">
                            {% for error in form.date_realization.errors %}<span>{{ error }}</span>{% endfor %}
                        </div>
                        {% endif %}
                        <small class="form-text text-muted">Target completion date.</small>
                    </div>
                </div>
            </div>

            <div class="form-group text-center mt-4">
                {{ form.submit(class="btn btn-primary btn-lg px-5") }}
                <a href="{{ url_for('home') }}" class="btn btn-outline-secondary btn-lg px-4">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    document.querySelectorAll(".drop-zone").forEach((dropZoneElement) => {
        const inputElement = dropZoneElement.querySelector(".drop-zone__input");

        // Click to upload
        dropZoneElement.addEventListener("click", (e) => {
            setFocus(dropZoneElement);
            // inputElement.click(); // Disabled as per user request
        });

        // Custom button handler
        const btnElement = dropZoneElement.querySelector(".drop-zone__btn");
        if (btnElement) {
            btnElement.addEventListener("click", (e) => {
                e.stopPropagation(); // Prevent bubbling to drop zone
                inputElement.click();
            });
        }

        inputElement.addEventListener("change", (e) => {
            if (inputElement.files.length) {
                updateThumbnail(dropZoneElement, inputElement.files[0]);
            }
        });

        // Prevention of default drag behaviors
        dropZoneElement.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZoneElement.classList.add("drop-zone--over");
        });

        ["dragleave", "dragend"].forEach((type) => {
            dropZoneElement.addEventListener(type, (e) => {
                dropZoneElement.classList.remove("drop-zone--over");
            });
        });

        dropZoneElement.addEventListener("drop", (e) => {
            e.preventDefault();
            setFocus(dropZoneElement);

            if (e.dataTransfer.files.length) {
                inputElement.files = e.dataTransfer.files;
                updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
            }

            dropZoneElement.classList.remove("drop-zone--over");
        });
    });

    // Default focus handling
    let lastClickedDropZone = document.querySelector("#drop-zone-problem");

    // Set initial focus
    setFocus(lastClickedDropZone);

    function setFocus(zone) {
        // Remove focus from all
        document.querySelectorAll(".drop-zone").forEach(z => z.classList.remove("drop-zone--focused"));
        // Add to current
        if (zone) {
            zone.classList.add("drop-zone--focused");
            lastClickedDropZone = zone;
        }
    }

    // Paste functionality
    window.addEventListener('paste', e => {
        if (e.clipboardData && e.clipboardData.items) {
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf("image") !== -1) {
                    const file = items[i].getAsFile();

                    if (lastClickedDropZone) {
                        const inputElement = lastClickedDropZone.querySelector(".drop-zone__input");

                        // Create a DataTransfer to set files property
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(file);
                        inputElement.files = dataTransfer.files;

                        updateThumbnail(lastClickedDropZone, file);
                        e.preventDefault(); // Prevent pasting into other elements if any
                    }
                    break;
                }
            }
        }
    });

    /**
     * Updates the thumbnail on a drop zone element.
     *
     * @param {HTMLElement} dropZoneElement
     * @param {File} file
     */
    function updateThumbnail(dropZoneElement, file) {
        let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");

        // First time - remove the prompt
        if (dropZoneElement.querySelector(".drop-zone__prompt")) {
            dropZoneElement.querySelector(".drop-zone__prompt").style.display = "none";
        }

        // First time - there is no thumbnail element, so lets create it
        if (!thumbnailElement) {
            thumbnailElement = document.createElement("div");
            thumbnailElement.classList.add("drop-zone__thumb");
            dropZoneElement.appendChild(thumbnailElement);
        }

        thumbnailElement.dataset.label = file.name;

        // Show thumbnail for image files
        if (file.type.startsWith("image/")) {
            const reader = new FileReader();

            reader.readAsDataURL(file);
            reader.onload = () => {
                thumbnailElement.style.backgroundImage = `url('${reader.result}')`;
            };
        } else {
            thumbnailElement.style.backgroundImage = null;
        }
    }
</script>
{% endblock content %}